# Stage 05 Wave Characterization

configfile: "config.yaml"
report: "report.rst"

output_folder_name = 'stage05_wave_characterization'

import os
import sys
sys.path.append('../')
from settings import output_path

if 'INPUT_FILE' in config:
    stage_input = config["INPUT_FILE"]
else:
    stage_input = os.path.join(output_path, 'stage04_wavefront_detection',
                               'waves.nix')

output_path = os.path.join(output_path, output_folder_name)

PLOT_FORMAT = config["PLOT_FORMAT"]
MEASURES = config["MEASURES"]

def input(wildcards):
    return stage_input

def measures_output(wildcards):
    return [os.path.join(output_path, measure, measure+'.csv')
            for measure in MEASURES]

rule all:
    input:
        data = measures_output,
        config = 'config.yaml',
        script = 'scripts/merge_dataframes.py'
    params:
        data = lambda wildcards, input:
                      ['"{}"'.format(path) for path in input.data]
    output:
        data = os.path.join(output_path, 'measures.csv'),
        img = report(os.path.join(output_path, 'overview_measures.html'))
    shell:
        """
        python {input.script} --data {input.data} \
                              --output "{output.data}" \
                              --output_img "{output.img}"
        """
# ToDo: combine rule with {metric} wildcard?

rule velocity_planar:
    input:
        data = input,
        script = 'scripts/velocity_planar.py'
    output:
        data = os.path.join(output_path, 'velocity_planar', 'velocity_planar.csv'),
        img = report(os.path.join(output_path, 'velocity_planar',
                                  'velocity_planar'+PLOT_FORMAT))
    shell:
        """
        python {input.script} --data "{input.data}" \
                              --output "{output.data}" \
                              --output_img "{output.img}"
        """

rule velocity_gradient:
    input:
        data = input,
        script = 'scripts/velocity_gradient.py'
    output:
        data = os.path.join(output_path, 'velocity_gradient',
                                         'velocity_gradient.csv'),
        img = report(os.path.join(output_path, 'velocity_gradient',
                                  'velocity_gradient'+PLOT_FORMAT))
    shell:
        """
        python {input.script} --data "{input.data}" \
                              --output "{output.data}" \
                              --output_img "{output.img}"
        """


rule direction:
    input:
        data = input,
        script = 'scripts/direction.py'
    output:
        data = os.path.join(output_path, 'direction', 'direction.csv'),
        img = report(os.path.join(output_path, 'direction',
                                  'direction'+PLOT_FORMAT))
    shell:
        """
        python {input.script} --data "{input.data}" \
                              --output "{output.data}" \
                              --output_img "{output.img}"
        """

# rule gradient_direction:
# slice signal for each wave

# rule inter_wave_distance:
